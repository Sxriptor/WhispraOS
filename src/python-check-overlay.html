<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Check - Whispra</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            margin: 0;
            padding: 1rem;
        }

        .overlay-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: url('assets/favicon-32x32.png') no-repeat center center;
            background-size: contain;
            border-radius: 8px;
        }

        .title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #000;
        }

        .subtitle {
            font-size: 1rem;
            color: #666;
            margin-bottom: 2rem;
        }

        .status-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .status-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #000;
        }

        .python-status {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .status-icon.success {
            background: #10b981;
            color: #fff;
        }

        .status-icon.error {
            background: #ef4444;
            color: #fff;
        }

        .status-icon.checking {
            background: #f59e0b;
            color: #fff;
        }

        .python-name {
            flex: 1;
            font-weight: 500;
        }

        .python-status-text {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .instructions {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .instructions h3 {
            color: #000;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .instructions p {
            color: #333;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .instructions .download-info {
            background: #e1f5fe;
            border: 1px solid #b3e5fc;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .instructions .download-info strong {
            color: #01579b;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #000;
            color: #fff;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #000;
            border: 1px solid #ccc;
        }

        .btn-secondary:hover {
            background: #e5e5e5;
        }

        .btn-success {
            background: #10b981;
            color: #fff;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fff5f5;
            border: 1px solid #fccaca;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #dc2626;
            font-size: 0.875rem;
        }

        .success-message {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #0c4a6e;
            font-size: 0.875rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 640px) {
            .overlay-container {
                padding: 1.5rem;
                margin: 1rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="overlay-container">
        <div class="logo"></div>
        <h1 class="title">Python 3.10.11 Required</h1>
        <p class="subtitle">Screen translation requires Python 3.10.11 to function properly</p>

        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>

        <div class="status-section">
            <h3 class="status-title">Python Status</h3>
            <div class="python-status">
                <div id="python-icon" class="status-icon checking">‚è≥</div>
                <div class="python-name">Python 3.10.11</div>
                <div class="python-status-text" id="python-status">Checking...</div>
            </div>
        </div>

        <div class="instructions">
            <h3>Installation Information</h3>
            <p>If you want to use screen translation, you must have Python 3.10.11 installed. Whispra will automatically download and install the required embedded Python version for you.</p>
            
            <div class="download-info">
                <strong>Windows Installation:</strong><br>
                Uses the Embeddable package ZIP (Python 3.10.11) from python.org<br>
                Download size: ~15-20 MB | Installed size: ~60-70 MB
            </div>
        </div>

        <div id="progress-section" style="display: none;">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <p id="progress-text" style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;">Preparing download...</p>
        </div>

        <div class="button-group">
            <button id="download-install-btn" class="btn btn-primary">
                <span>‚¨áÔ∏è</span>
                Download & Install Python 3.10.11
            </button>
            <button id="rescan-btn" class="btn btn-secondary">
                <span id="rescan-icon">üîÑ</span>
                Check Again
            </button>
            <button id="manual-download-btn" class="btn btn-secondary">
                <span>üåê</span>
                Manual Download
            </button>
            <button id="cancel-btn" class="btn btn-secondary">
                <span>‚ùå</span>
                Cancel
            </button>
            <button id="continue-btn" class="btn btn-success" style="display: none;">
                <span>‚úÖ</span>
                Continue to Screen Translation
            </button>
        </div>
    </div>

    <script>
        // Initialize the overlay
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Python check overlay initialized');
            
            // Check Python immediately
            await checkPython();
            
            // Set up event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('download-install-btn').addEventListener('click', downloadAndInstallPython);
            document.getElementById('rescan-btn').addEventListener('click', rescanPython);
            document.getElementById('manual-download-btn').addEventListener('click', openManualDownload);
            document.getElementById('cancel-btn').addEventListener('click', cancelPythonCheck);
            document.getElementById('continue-btn').addEventListener('click', continuePythonCheck);
        }

        async function checkPython() {
            try {
                // Clear any previous messages
                hideMessages();
                
                console.log('Checking Python version...');
                const result = await window.electronAPI.checkPythonVersion();
                
                console.log('Python check result:', result);
                
                updatePythonStatus(result.hasCorrectVersion, result.currentVersion, result.error);

                if (result.hasCorrectVersion) {
                    showPythonFound();
                } else {
                    showPythonMissing(result.currentVersion || 'Not found');
                }

            } catch (error) {
                console.error('Error checking Python:', error);
                showError('Failed to check Python version. Please try again.');
                updatePythonStatus(false, 'Error', error.message);
            }
        }

        function updatePythonStatus(isPresent, version, error) {
            const icon = document.getElementById('python-icon');
            const status = document.getElementById('python-status');
            
            if (isPresent) {
                icon.className = 'status-icon success';
                icon.textContent = '‚úì';
                status.textContent = `Found: ${version}`;
            } else {
                icon.className = 'status-icon error';
                icon.textContent = '‚úï';
                status.textContent = error || `Not found: ${version}`;
            }
        }

        function showPythonFound() {
            showSuccess('Python 3.10.11 is installed and ready!');
            document.getElementById('download-install-btn').style.display = 'none';
            document.getElementById('manual-download-btn').style.display = 'none';
            document.getElementById('continue-btn').style.display = 'inline-flex';
        }

        function showPythonMissing(currentVersion) {
            showError(`Python 3.10.11 not found. Current version: ${currentVersion}`);
            document.getElementById('continue-btn').style.display = 'none';
        }

        async function downloadAndInstallPython() {
            const downloadBtn = document.getElementById('download-install-btn');
            const progressSection = document.getElementById('progress-section');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            try {
                // Disable button and show progress
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<div class="loading"></div> Installing...';
                progressSection.style.display = 'block';
                
                // Simulate progress updates
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90;
                    progressFill.style.width = progress + '%';
                    
                    if (progress < 30) {
                        progressText.textContent = 'Downloading Python 3.10.11...';
                    } else if (progress < 70) {
                        progressText.textContent = 'Extracting files...';
                    } else {
                        progressText.textContent = 'Finalizing installation...';
                    }
                }, 200);

                console.log('Starting Python download and installation...');
                const result = await window.electronAPI.downloadAndInstallPython();
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressText.textContent = 'Installation complete!';
                
                if (result.success) {
                    showSuccess('Python 3.10.11 installed successfully!');
                    await checkPython(); // Re-check to update status
                } else {
                    throw new Error(result.error || 'Installation failed');
                }

            } catch (error) {
                console.error('Error installing Python:', error);
                showError(`Installation failed: ${error.message}`);
                progressSection.style.display = 'none';
            } finally {
                // Restore button state
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<span>‚¨áÔ∏è</span> Download & Install Python 3.10.11';
            }
        }

        async function rescanPython() {
            const rescanBtn = document.getElementById('rescan-btn');
            const rescanIcon = document.getElementById('rescan-icon');
            
            // Show loading state
            rescanBtn.disabled = true;
            rescanIcon.innerHTML = '<div class="loading"></div>';
            
            try {
                await checkPython();
            } catch (error) {
                console.error('Error during rescan:', error);
                showError('Failed to check Python. Please try again.');
            } finally {
                // Restore button state
                rescanBtn.disabled = false;
                rescanIcon.textContent = 'üîÑ';
            }
        }

        function openManualDownload() {
            window.electronAPI.openExternal('https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip');
        }

        async function cancelPythonCheck() {
            console.log('Cancel button clicked');
            try {
                await window.electronAPI.pythonCheckComplete({ cancelled: true });
                console.log('Python check cancelled successfully');
            } catch (error) {
                console.error('Error during cancel:', error);
                showError('Failed to cancel. Please try again.');
            }
        }

        async function continuePythonCheck() {
            console.log('Continue button clicked');
            try {
                await window.electronAPI.pythonCheckComplete({ cancelled: false });
                console.log('Python check completed successfully');
            } catch (error) {
                console.error('Error during continue:', error);
                showError('Failed to continue. Please try again.');
            }
        }

        function showError(message) {
            hideMessages();
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function showSuccess(message) {
            hideMessages();
            const successElement = document.getElementById('success-message');
            successElement.textContent = message;
            successElement.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
    </script>
</body>
</html>
